<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plus Code Compass Navigator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-primary: #000000;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* Thick Hand-Drawn Style UI */
        .glass-panel {
            background: #fff;
            border: 8px solid #000;
            box-shadow: 12px 12px 0px 0px #000;
        }

        .btn-bold {
            border: 8px solid #000;
            box-shadow: 8px 8px 0px 0px #000;
            transition: all 0.1s;
        }

        .btn-bold:active {
            box-shadow: 0px 0px 0px 0px #000;
            transform: translate(8px, 8px);
        }

        .btn-bold:disabled {
            background: #eee;
            color: #aaa;
            box-shadow: none;
            border-color: #aaa;
            transform: none;
        }

        .input-bold {
            border: 8px solid #000;
            box-shadow: 8px 8px 0px 0px #000;
        }

        .compass-container {
            position: relative;
            width: 85vw;
            height: 85vw;
            max-width: 450px;
            max-height: 450px;
            margin: 3rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Thick Line Art Arrow */
        .thick-stroke {
            stroke: #000;
            stroke-width: 14;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        #arrow-rotator {
            transition: transform 0.25s cubic-bezier(0.25, 0.1, 0.25, 1);
            will-change: transform;
            transform-origin: center;
        }

        .step-bubble {
            width: 40px;
            height: 40px;
            border: 6px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.2rem;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center min-h-screen">

    <header class="w-full max-w-md mb-8 text-center">
        <h1 class="text-4xl font-black uppercase tracking-tighter italic">Navigator</h1>
        <p class="text-xs font-black opacity-40 uppercase tracking-widest">Minimal Compass Logic</p>
    </header>

    <!-- HTTPS & Permission Guard -->
    <div id="guard-screen" class="w-full max-w-md glass-panel p-8 space-y-6 z-50">
        <h2 class="text-2xl font-black italic underline decoration-8">SETUP</h2>
        
        <div id="https-warning" class="hidden text-red-600 font-black border-[6px] border-red-600 p-4 mb-2">
            ⚠️ HTTPS REQUIRED FOR SENSORS
        </div>
        
        <div class="space-y-6">
            <div id="step-location" class="flex items-center space-x-4">
                <div class="step-bubble" id="icon-location">1</div>
                <span class="font-black text-lg">LOCATION</span>
            </div>
            <div id="step-orientation" class="flex items-center space-x-4">
                <div class="step-bubble" id="icon-orientation">2</div>
                <span class="font-black text-lg">COMPASS</span>
            </div>
        </div>

        <button id="btn-enable-permissions" class="w-full py-5 bg-black text-white font-black uppercase tracking-tighter text-xl btn-bold">
            GRANT ACCESS
        </button>
    </div>

    <!-- Main Navigation UI -->
    <main id="nav-screen" class="hidden w-full max-w-md flex flex-col flex-grow items-center">
        
        <div class="w-full space-y-2 mb-8">
            <label for="plus-code-input" class="text-xs font-black uppercase opacity-40">Plus Code Target</label>
            <input type="text" id="plus-code-input" placeholder="7J4V+5W BENGALURU" 
                   class="w-full p-5 bg-white font-black text-xl uppercase input-bold focus:outline-none">
            <p id="input-error" class="text-red-600 font-black text-sm hidden">INVALID CODE</p>
        </div>

        <button id="btn-start-nav" class="w-full py-5 bg-black text-white font-black uppercase tracking-tighter text-xl btn-bold mb-10">
            START GUIDANCE
        </button>

        <div class="w-full text-center mb-6">
            <div class="glass-panel p-6">
                <span class="text-xs font-black uppercase block opacity-40 mb-1">Target Distance</span>
                <span id="distance-display" class="text-6xl font-black tracking-tighter">---</span>
            </div>
        </div>

        <div class="compass-container">
            <svg id="compass-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <!-- Circular Guide -->
                <circle cx="100" cy="100" r="90" class="thick-stroke" style="opacity: 0.1;"/>
                <!-- Simple Monochrome Line Art Arrow -->
                <g id="arrow-rotator">
                    <path d="M100 25 L165 160 L100 135 L35 160 Z" class="thick-stroke" />
                </g>
            </svg>
            <div id="calibration-msg" class="absolute bottom-[-30px] left-0 right-0 text-center text-xs font-black uppercase opacity-30 hidden">
                CALIBRATE: MOVE PHONE IN '8' PATTERN
            </div>
        </div>

        <div id="arrival-msg" class="hidden p-6 border-[8px] border-black bg-white font-black text-2xl text-center w-full mb-8">
            ARRIVED ✅
        </div>

        <button id="btn-stop-nav" class="hidden w-full py-5 bg-white border-[8px] border-black font-black uppercase tracking-tighter text-xl btn-bold mt-auto mb-6">
            STOP
        </button>
    </main>

    <footer class="mt-auto py-6 text-[10px] font-black uppercase opacity-20 text-center tracking-widest">
        Device-Only Processing • No Tracking
    </footer>

    <script>
        /**
         * BROWSER-COMPATIBLE PLUS CODE DECODER
         */
        const PlusCode = {
            ALPHABET: "23456789CFGHJMPQRVWX",
            decode: function(code) {
                code = code.split(' ')[0].replace("+", "").toUpperCase();
                let lat = 0, lng = 0;
                let latRes = 20, lngRes = 20;
                for (let i = 0; i < Math.min(code.length, 10); i += 2) {
                    lat += this.ALPHABET.indexOf(code[i]) * latRes;
                    lng += this.ALPHABET.indexOf(code[i+1]) * lngRes;
                    latRes /= 20;
                    lngRes /= 20;
                }
                return { lat: (lat - 90) + (latRes * 10), lng: (lng - 180) + (lngRes * 10) };
            },
            isValid: function(code) {
                if (!code || typeof code !== 'string') return false;
                const parts = code.trim().split(' ');
                const main = parts[0];
                if (main.indexOf('+') === -1) return false;
                const clean = main.replace('+', '');
                if (clean.length < 4) return false;
                for(let char of clean) {
                    if (this.ALPHABET.indexOf(char.toUpperCase()) === -1) return false;
                }
                return true;
            }
        };

        const state = {
            isNavigating: false,
            currentPos: null,
            targetPos: null,
            smoothedHeading: 0,
            smoothedDistance: null,
            watchId: null,
            alpha: 0.18, // Smoothing constant
            accuracy: 0
        };

        const elements = {
            guard: document.getElementById('guard-screen'),
            nav: document.getElementById('nav-screen'),
            input: document.getElementById('plus-code-input'),
            inputError: document.getElementById('input-error'),
            btnEnable: document.getElementById('btn-enable-permissions'),
            btnStart: document.getElementById('btn-start-nav'),
            btnStop: document.getElementById('btn-stop-nav'),
            distance: document.getElementById('distance-display'),
            arrow: document.getElementById('arrow-rotator'),
            arrival: document.getElementById('arrival-msg'),
            httpsWarning: document.getElementById('https-warning'),
            calibration: document.getElementById('calibration-msg')
        };

        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            elements.httpsWarning.classList.remove('hidden');
            elements.btnEnable.disabled = true;
        }

        elements.btnEnable.addEventListener('click', async () => {
            try {
                await new Promise((res, rej) => {
                    navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true });
                });
                document.getElementById('icon-location').innerHTML = '✓';
                document.getElementById('icon-location').style.background = '#000';
                document.getElementById('icon-location').style.color = '#fff';

                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') throw new Error('SENSOR PERMISSION DENIED');
                }
                
                document.getElementById('icon-orientation').innerHTML = '✓';
                document.getElementById('icon-orientation').style.background = '#000';
                document.getElementById('icon-orientation').style.color = '#fff';

                setTimeout(() => {
                    elements.guard.classList.add('hidden');
                    elements.nav.classList.remove('hidden');
                }, 400);
            } catch (err) {
                alert("ERROR: " + err.message);
            }
        });

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180, φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180, Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI / 180, φ2 = lat2 * Math.PI / 180;
            const λ1 = lon1 * Math.PI / 180, λ2 = lon2 * Math.PI / 180;
            const y = Math.sin(λ2 - λ1) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(λ2 - λ1);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }

        function handleOrientation(event) {
            let heading = event.webkitCompassHeading;
            if (heading === undefined) {
                heading = event.alpha ? 360 - event.alpha : 0;
            }
            
            const screenOrientation = window.orientation || 0;
            heading = (heading + screenOrientation + 360) % 360;

            // Handle 0/360 boundary for smoothing
            if (Math.abs(heading - state.smoothedHeading) > 180) {
                if (heading > state.smoothedHeading) state.smoothedHeading += 360;
                else state.smoothedHeading -= 360;
            }
            state.smoothedHeading = (state.alpha * heading) + (1 - state.alpha) * state.smoothedHeading;
            updateUI();
        }

        elements.btnStart.onclick = () => {
            const val = elements.input.value.trim();
            if (!PlusCode.isValid(val)) {
                elements.inputError.classList.remove('hidden');
                return;
            }

            elements.inputError.classList.add('hidden');
            state.targetPos = PlusCode.decode(val);
            state.isNavigating = true;
            elements.btnStart.classList.add('hidden');
            elements.btnStop.classList.remove('hidden');
            elements.input.disabled = true;

            window.addEventListener('deviceorientation', handleOrientation, true);
            state.watchId = navigator.geolocation.watchPosition(pos => {
                state.currentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                state.accuracy = pos.coords.accuracy;
                updateUI();
            }, null, { enableHighAccuracy: true });
        };

        elements.btnStop.onclick = () => {
            state.isNavigating = false;
            window.removeEventListener('deviceorientation', handleOrientation);
            navigator.geolocation.clearWatch(state.watchId);
            elements.btnStart.classList.remove('hidden');
            elements.btnStop.classList.add('hidden');
            elements.input.disabled = false;
            elements.distance.innerText = "---";
            elements.arrival.classList.add('hidden');
            elements.arrow.style.transform = `rotate(0deg)`;
        };

        function updateUI() {
            if (!state.isNavigating || !state.currentPos || !state.targetPos) return;

            const dist = calculateDistance(state.currentPos.lat, state.currentPos.lng, state.targetPos.lat, state.targetPos.lng);
            state.smoothedDistance = state.smoothedDistance === null ? dist : (0.15 * dist + 0.85 * state.smoothedDistance);
            
            elements.distance.innerText = state.smoothedDistance >= 1000 ? (state.smoothedDistance / 1000).toFixed(1) + "km" : Math.round(state.smoothedDistance) + "m";
            elements.arrival.classList.toggle('hidden', state.smoothedDistance >= 15);

            const bearing = calculateBearing(state.currentPos.lat, state.currentPos.lng, state.targetPos.lat, state.targetPos.lng);
            // Result is Bearing relative to true north - device heading
            elements.arrow.style.transform = `rotate(${bearing - state.smoothedHeading}deg)`;
        }
    </script>
</body>
</html>